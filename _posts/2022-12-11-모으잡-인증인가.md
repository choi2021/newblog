---
title: "ëª¨ìœ¼ì¡-SSRì„ ì´ìš©í•œ ì¸ì¦,ì¸ê°€ ë„ì…"
categories: ëª¨ìœ¼ì¡
tags: ["project", "ëª¨ìœ¼ì¡"]
---

# ğŸ”“ SSRì„ ì´ìš©í•œ ì¸ì¦/ì¸ê°€ ë„ì…

ì´ë²ˆì— í”„ë¡œì íŠ¸ë¥¼ ê³ ë¯¼í•˜ë©´ì„œ í•­ìƒ ë‹µë‹µí–ˆë˜ ë¶€ë¶„ì´ì—ˆë˜ í˜ì´ì§€ redirectionê³¼ userìƒíƒœ ê´€ë¦¬ì— ëŒ€í•´ ë” ê¹Šì´ ê³µë¶€í–ˆë‹¤. CSRë¡œ ê´€ë¦¬í•˜ë˜ userìƒíƒœë¥¼ SSRë¡œ ìˆ˜ì •í•˜ê¸°ê¹Œì§€ ê³¼ì •ì„ ì •ë¦¬í•´ ë³´ë ¤ í•œë‹¤.



## ğŸ˜… Firebaseì˜ onAuthStateChangedë¥¼ ì´ìš©í•œ User ìƒíƒœ ê´€ë¦¬

ê¸°ì¡´ Authenticationì€ firebase Authë¥¼ ì´ìš©í•´ ë°›ì•„ì˜¨ userì •ë³´ì˜ tokenì„ localstorageì— ì €ì¥í•´ì„œ í™•ì¸í–ˆë‹¤. firebaseë¥¼ ê³µë¶€í•˜ë©´ì„œ firebase Authì˜ APIì¸ onAuthStateChangedê°€ ìˆë‹¤ëŠ” ê²ƒì„ ì•Œê²Œ ë˜ì—ˆê³ , APIë¥¼ ì´ìš©í•œë‹¤ë©´ ë³„ë„ì˜ í† í°ê³¼ ì¿ í‚¤ë¥¼ ì €ì¥í•˜ì§€ ì•Šì•„ë„ ë  ê²ƒì´ë€ ì˜ˆìƒì´ ë˜ì–´ ì ìš©í–ˆë‹¤.   

```tsx
//AuthService.ts
export class AuthServiceImpl implements AuthService {
  googleProvider: GoogleAuthProvider;
  githubProvider: GithubAuthProvider;
  auth: Auth;

  constructor(private app: FirebaseApp) {
    this.googleProvider = new GoogleAuthProvider();
    this.githubProvider = new GithubAuthProvider();
    this.auth = getAuth(this.app);
  }
    ...
  onUserStateChanged(callback: Dispatch<SetStateAction<User | null>>) {
    return onAuthStateChanged(this.auth, callback);
  }
}

//AuthContext.tsx

type InitialValue = {
  authService: AuthService;
  user: User | null;
};

const AuthContext = createContext<InitialValue | null>(null);
export const AuthProvider = ({ children, authService }: AuthProviderProps) => {
  const [user, setUser] = useState<User | null>(null);
  useEffect(() => {
    authService.onUserStateChanged((user) => {
      setUser(user);
    });
  }, []);

  return (
    <AuthContext.Provider value={{ user, authService }}>
      {children}
    </AuthContext.Provider>
  );
};

export const useAuthService = () => {
  const context = useContext(AuthContext);
  if (!context) {
    throw new Error('Not under AuthProvider');
  }
  return context;
};

```



ì´ë ‡ê²Œ ìˆ˜ì •í•˜ê³  APIë¥¼ ì´ìš©í•´ loginìƒíƒœë¥¼ í™•ì¸í•´ì„œ í˜ì´ì§€ ì´ë™ì„ í•˜ë‹¤ ë³´ë‹ˆ ë‹¤ë¥¸ ë¬¸ì œê°€ ìƒê²¼ë‹¤. ëœë”ë§ì„ í•˜ê³  APIë¡œ userìƒíƒœë¥¼ ë°”ê¾¸ê¸° ì „, ì´ˆê¸° ê°’ì´ nullë¡œ ë˜ì–´ìˆì–´ react-Queryë¡œ API í˜¸ì¶œì‹œ **userê°€ ì—†ëŠ” ìƒíƒœë¡œ í˜¸ì¶œ**ë˜ì–´ ì—ëŸ¬ê°€ ë‚˜íƒ€ë‚¬ë‹¤. react queryë¥¼ ì´ìš©í•´ APIë¥¼ ë°›ì•„ì˜¬ ë•Œ userIdê°€ í•„ìš”í•˜ê¸° ë•Œë¬¸ì— ë°œìƒí•œ ì—ëŸ¬ì˜€ê¸° ë•Œë¬¸ì— ìš°ì„  useJobs í›… ë‚´ë¶€ì—ì„œ userìƒíƒœê°€ ë‹¬ë¼ì§€ë©´ refetchí•´ ë°›ì•„ì™€ í•´ê²°í–ˆë‹¤. 

```typescript
export const useSpecificJobs = () => {
  const { user } = useAuthService();
  const { query } = useRouter();
  const { id } = query;
  const dbService = useDBService();

  const getFilteredJobs = useQuery(
    [JOBS_KEY],
    () => {
      if (!user) {
        return {};
      }
      return dbService.getJobs(user);
    },
    {
      select: (data: ModifiedJobsType) => {
        if (!data) {
          return [];
        }
        return Object.values(data).filter((item) => item.id !== id);
      },
      onError: (error) => {
        console.log(error);
      },
    }
  );
  useEffect(() => {
    getFilteredJobs.refetch();
  }, [user]);
	...
};
```



í•˜ì§€ë§Œ ì´ì „ ì±„ìš©ê³µê³ ë“¤ì„ ë°›ì•„ì˜¤ê¸° ê¹Œì§€ ê³¼ì •ì´ 1) ë©”ì¸ í˜ì´ì§€ ë Œë”ë§-> 2) react Query APIí˜¸ì¶œ -> 3) Userìƒíƒœ ì—…ë°ì´íŠ¸-> 4) reactQuery API í˜¸ì¶œë¡œ **ê°™ì€ APIë¥¼ ë‘ë²ˆ í˜¸ì¶œí•˜ëŠ” ê³¼ì •ì—ì„œ ì‹œê°„ì´ ë” ì˜¤ë˜ ê±¸ë¦¬ê²Œ ë˜ì—ˆë‹¤**. í•´ê²° ë°©ë²•ìœ¼ë¡œ userë¥¼ ë°›ì€ í›„ì— APIì½œì´ ì¼ì–´ë‚˜ê²Œ í•  ë°©ë²•ì´ ì—†ì„ê¹Œ, authë¥¼ server-sideë¡œ ë¨¼ì € ë°›ì•„ì˜¬ ìˆ˜ëŠ” ì—†ì„ê¹Œë¼ëŠ” ê³ ë¯¼ì´ ë“¤ì—ˆë‹¤. ì´ëŸ° í˜ì´ì§€ ì´ë™ê³¼ ì¸ì¦/ì¸ê°€ëŠ” í•­ìƒ í”„ë¡œì íŠ¸ë¥¼ í•˜ë©´ì„œ ë°œëª©ì„ ì¡ì•˜ë˜ ë¶€ë¶„ì´ê¸° ë•Œë¬¸ì— ê´€ë ¨ ìë£Œë¥¼ ì°¾ì•„ ê³µë¶€í•˜ëŠ” ê²Œ ìš°ì„ ì´ë¼ëŠ” ìƒê°ì´ ë“¤ì—ˆë‹¤. 



## ğŸ’» CSRì—ì„œì˜ í•´ê²°ë²•: Protected Route ë„ì…

### 1) ë¡œê·¸ì¸ flow ìˆ˜ì •í•˜ê¸°

ë¨¼ì € ê°€ì¥ ì‹œê¸‰í•œ ë¬¸ì œëŠ” ë¡œê·¸ì¸ í›„ì— ë©”ì¸ í˜ì´ì§€ ì´ë™ì‹œì— Userê°€ ì—†ëŠ” ìƒíƒœë¡œ APIê°€ í˜¸ì¶œëœë‹¤ëŠ” ì ì´ì—ˆë‹¤. ì´ê²ƒì„ ë§‰ê¸° ìœ„í•´ì„œëŠ” ë¨¼ì € userìƒíƒœë¥¼ ê´€ë¦¬í•´ì¤„ ìˆ˜ ìˆëŠ” componentê°€ í•„ìš”í–ˆê³ , AuthStateChangedë¼ëŠ” ì»´í¬ë„ŒíŠ¸ë¥¼ ë§Œë“¤ì–´ ì»´í¬ë„ŒíŠ¸ê°€ ë§ˆìš´íŠ¸ë˜ë©´ Userë¥¼ ë°›ì•„ì˜¤ê³ , ì´í›„ì— ë©”ì¸í˜ì´ì§€ê°€ ë Œë”ë§ ë  ìˆ˜ ìˆê²Œ í–ˆë‹¤.

```tsx
// AuthStateChanged.tsx

import React, { useEffect, useState } from 'react';
import { useAuthService } from '../context/AuthContext';

export default function AuthStateChanged({
  children,
}: {
  children: React.ReactNode;
}) {
  const { authService, setUser } = useAuthService();

  const [loading, setLoading] = useState(true);
  useEffect(() => {
    authService.onUserStateChanged((user) => {
      setUser(user);
      setLoading(false);
    });
  }, []);

  if (loading) {
    return <h1>ë¡œë”©ì¤‘</>;
  }

  return <>{children}</>;
}

// _app.tsx
    
function MyApp({ Component, pageProps }: AppProps) {
    ...
  return (
    <>
      <QueryClientProvider client={queryClient}>
        <DBProvider dbService={dbService}>
          <AuthProvider authService={authService}>
            <AuthStateChanged>
              <ThemeProvider theme={theme}>
                <GlobalStyle />
                <Component {...pageProps} />
              </ThemeProvider>
            </AuthStateChanged>
          </AuthProvider>
        </DBProvider>
      </QueryClientProvider>
    </>
  );
}
export default MyApp;
 
```

Userê°€ ìˆì–´ì•¼ë§Œ ë‹¤ìŒ ì»´í¬ë„ŒíŠ¸ë“¤ë¡œ ë„˜ì–´ê°€ ë™ì‘í•˜ê¸° ë•Œë¬¸ì— ì´ì „ ê°€ì¥ í° ë¬¸ì œì˜€ë˜ 1) ë©”ì¸ í˜ì´ì§€ ë Œë”ë§-> 2) react Query APIí˜¸ì¶œ -> 3) Userìƒíƒœ ì—…ë°ì´íŠ¸-> 4) reactQuery API í˜¸ì¶œ ìˆœì„œì—ì„œ ì •ìƒì ìœ¼ë¡œ 1) ë©”ì¸ í˜ì´ì§€ ë Œë”ë§-> 2) Userìƒíƒœ ì—…ë°ì´íŠ¸-> 3) reactQuery API í˜¸ì¶œë¡œ ìˆ˜ì •í•  ìˆ˜ ìˆë‹¤. ë•ë¶„ì— ì •ìƒì ìœ¼ë¡œ ë¬¸ì œì—†ì´ react-query APIë“¤ì„ ì‚¬ìš©í•  ìˆ˜ ìˆì—ˆë‹¤.

í•˜ì§€ë§Œ ì—¬ì „íˆ ì‚´ì§ ë¬¸ì œê°€ ë‚¨ì•„ìˆì—ˆë˜ ê²ƒì€ AuthStateChangedì—ì„œ Userë¥¼ ë°›ì•„ì˜¤ëŠ” ë™ì•ˆ **í™”ë©´ì— ë¡œë”©ì„ ë³´ì—¬ì¤˜ì•¼í•œë‹¤**ëŠ” ì ì´ì—ˆë‹¤. ë¡œë”©ì„ ì•ˆë³´ì—¬ì£¼ê¸° ìœ„í•´ loadingì´ trueì¼ ë•Œ `<></>` ë¦¬ì•¡íŠ¸ fragmentë¡œ ë°˜í™˜í•œë‹¤í•´ë„ ì—¬ì „íˆ ë¶ˆëŸ¬ì˜¤ëŠ” ë™ì•ˆì˜ ë¹ˆí˜ì´ì§€ê°€ ë³´ì˜€ë‹¤.



[AuthStateChanged ì»´í¬ë„ŒíŠ¸ë¥¼ ì¶”ê°€í•œ í›„ ìƒˆë¡œê³ ì¹¨í•œ ëª¨ìŠµ]

<img src="/assets/img/2022-12-11-ëª¨ìœ¼ì¡-ì¸ì¦ì¸ê°€/ezgif.com-gif-maker (1).gif" width="700" />



### 2) Protected Route

ë‘ë²ˆì§¸ë¡œ ë¡œê·¸ì¸í•˜ì§€ ì•Šê³  ë©”ì¸í˜ì´ì§€ì— ì ‘ì†í•˜ëŠ” ê²½ìš°ì™€ ë¡œê·¸ì¸ í›„ì—ë„ ë¡œê·¸ì¸ í˜ì´ì§€ì— ì ‘ì†í•˜ë ¤ëŠ” ê²½ìš°ë¥¼ ë§‰ê¸° ìœ„í•œ redirectionë¡œì§ì´ í•„ìš”í–ˆë‹¤. ì´ê²ƒì„ ìœ„í•´ì„œ AuthStateChanged ì»´í¬ë„ŒíŠ¸ì™€ ìœ ì‚¬í•˜ê²Œ ì¡°ê±´ì— ë”°ë¼ ëœë”ë§ì„ í•´ì¤„ ìˆ˜ ìˆëŠ” ProtectedRoutes ì»´í¬ë„ŒíŠ¸ë¥¼ ì¶”ê°€í–ˆë‹¤. Protected RouteëŠ” í•„ìš”í•œ í˜ì´ì§€ì— ë§ê²Œ ì‚¬ìš©ë˜ì–´ì•¼ í–ˆê¸° ë•Œë¬¸ì— typeì„ ì •í•  ë•Œ Genericìœ¼ë¡œ ì •í•´ì¤„ ìˆ˜ ìˆì—ˆë‹¤.



```tsx
//ProtectRoute.tsx

import { useRouter } from 'next/router';
import React, { ComponentType } from 'react';
import { useAuthService } from '../context/AuthContext';
export function withPublic<T>(Component: ComponentType<T>) {
  return function WithPublic(props: T) {
    const auth = useAuthService();
    const router = useRouter();
    if (auth.user) {
      router.replace('/');
      return <></>;
    }
    return <Component auth={auth} {...props} />;
  };
}

export function withProtected<T>(Component: React.ComponentType<T>) {
  return function WithProtected(props: T) {
    const auth = useAuthService();
    const router = useRouter();
    if (!auth.user) {
      router.replace('/login');
      return <></>;
    }
    return <Component auth={auth} {...props} />;
  };
}

// pages/login.tsx
function Login() {
	...
}
    
export default withPublic(Login);

// Pages/register.tsx
function Register() {
  ...
}

export default withPublic(Register);

    
// pages/index.tsx
function Home() {
	 ...
}

export default withProtected(Home);

// pages/job/[id].tsx

function Index() {
 	...
}

export default withProtected(Index);


```

Protected Routeë¥¼ ì´ìš©í•´ homeì—ì„œ loginìœ¼ë¡œ ì´ë™í•˜ê±°ë‚˜ loginì—ì„œ homeìœ¼ë¡œ urlì„ ì´ìš©í•œ ì´ë™ì„ ë§‰ì„ ìˆ˜ ìˆì—ˆë‹¤. í•˜ì§€ë§Œ ì—¬ì „íˆ ì•ì„œ ë¬¸ì œê°€ ë˜ì—ˆë˜ í˜ì´ì§€ ì´ë™ê¹Œì§€ ì‹œê°„ë™ì•ˆ **ë¡œë”©ì„ ë³´ì—¬ì¤˜ì•¼í•˜ëŠ” ë¬¸ì œ**ê°€ ìˆì—ˆë‹¤. ë˜‘ê°™ì´ React.Fragmentë¡œ ë¹ˆí˜ì´ì§€ë¡œ ë³´ì—¬ì¤˜ë„ ë˜ì§€ë§Œ, Protected Routesë¥¼ ì•Œê¸°ì „ì— í•´ê²°ë°©ë²•ìœ¼ë¡œ ë– ì˜¬ë ¸ë˜ **ì„œë²„ì‚¬ì´ë“œ**ì—ì„œ authë¥¼ ë¯¸ë¦¬ ë°›ì•„ì™€ì„œ ë Œë”ë§ì „ì— í˜ì´ì§€ ì´ë™ì„ ì‹œí‚¤ê³ , í•´ë‹¹ í˜ì´ì§€ì—ì„œ authë¥¼ ë°”ë¡œ ë°›ì•„ë³¼ ìˆ˜ ìˆë‹¤ë©´ ì¢€ ë” ë¡œì§ë„ ê°„ë‹¨í•´ì§€ê³ , nextë¥¼ ì˜ í™œìš©í•˜ëŠ” ë°©ë²•ì´ ë˜ì§€ì•Šì„ê¹Œë¼ëŠ” ìƒê°ì´ ë“¤ì—ˆë‹¤.



## ğŸ’¾ SSRë¡œ ì „í™˜





